[platformio]
default_envs = esp32c3-prod, esp32c3-prod-no-leds, esp32s3-mini-prod, lolin32lite-no-leds

; ========================================
; COMMON CONFIGURATION
; ========================================

[common]
lib_deps_base = 
    arduino-libraries/NTPClient@^3.2.1
    ropg/ezTime@^0.8.3
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8
    thijse/ArduinoLog@^1.1.1
    esphome/AsyncTCP-esphome@^2.1.4
    esphome/ESPAsyncWebServer-esphome@^3.4.0

build_flags_base = 
    -Isrc
    -std=gnu++17
    -DBOARD_HAS_PSRAM=0
    -DASYNC_TCP_SSL_ENABLED=0
    -DCONFIG_ASYNC_TCP_MAX_ACK_TIME=3000
    -DCONFIG_ASYNC_TCP_PRIORITY=10
    -DCONFIG_ASYNC_TCP_QUEUE_SIZE=32
    -DASYNCWEBSERVER_REGEX=1
    -DDISABLE_OTA=1
    -DARDUINOJSON_USE_LONG_LONG=0

build_unflags_base = 
    -O2
    -std=gnu++11

; Release optimization profile
build_flags_release = 
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -DCORE_DEBUG_LEVEL=1

; Debug profile
build_flags_debug = 
    -O0
    -g3
    -ggdb
    -DCORE_DEBUG_LEVEL=5

; ========================================
; BASE ENVIRONMENTS
; ========================================

[env:esp32c3_base]
platform = espressif32@^6.9.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
board_build.filesystem = littlefs
board_build.partitions = partitions_no_ota.csv
lib_deps = ${common.lib_deps_base}
build_flags = 
    ${common.build_flags_base}
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
build_unflags = ${common.build_unflags_base}

[env:lolin32_base]
platform = espressif32@^6.9.0
board = lolin32
framework = arduino
monitor_speed = 115200
upload_speed = 460800
board_build.filesystem = littlefs
board_build.partitions = partitions_no_ota.csv
lib_deps = ${common.lib_deps_base}
build_flags = ${common.build_flags_base}
build_unflags = ${common.build_unflags_base}

[env:esp32s3_base]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions_8mb_ota.csv
board_build.flash_mode = dio
board_upload.flash_size = 8MB
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
build_unflags = ${common.build_unflags_base}

; ========================================
; PRODUCTION BUILD ENVIRONMENTS
; ========================================

[env:esp32c3-prod]
extends = env:esp32c3_base
lib_deps = 
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.7.8
build_flags = 
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts = 
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:esp32c3-prod-no-leds]
extends = env:esp32c3_base
build_flags = 
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=0
extra_scripts = 
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:lolin32lite-no-leds]
extends = env:lolin32_base
build_flags =
    ${env:lolin32_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:esp32s3-mini-prod]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.7.8
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

; ========================================
; DEVELOPMENT ENVIRONMENT
; ========================================

[env:esp32c3-dev]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.7.8
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
    -DBOARD_ESP32C3_MINI
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

[env:esp32s3-mini-dev]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.7.8
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

; ========================================
; TEST ENVIRONMENT
; ========================================

[env:esp32c3-test]
extends = env:esp32c3_base
lib_deps = 
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.7.8
build_flags = 
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DARDUINO_JSON_USE_DOUBLE=0
    -DENABLE_LEDS=1
    -Wl,--gc-sections
build_src_filter = +<*> -<main.cpp>
monitor_filters = 
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
upload_speed = 115200
test_framework = unity
test_speed = 115200
test_filter = *
test_build_src = yes
test_ignore = test_integration_* 
debug_test = *
debug_build_flags = -O0 -g3 -ggdb
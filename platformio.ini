[platformio]
default_envs = c3-4mb-prod, s3-4mb-prod, s3-pcb-prod, s3-pcb-dev

; ========================================
; COMMON CONFIGURATION
; ========================================

[common]
lib_deps_base =
    arduino-libraries/NTPClient@^3.2.1
    ropg/ezTime@^0.8.3
    bblanchon/ArduinoJson@^7.4.2
    cyijun/ESP32MQTTClient@^1.1.1
    esphome/AsyncTCP-esphome@^2.1.4
    esphome/ESPAsyncWebServer-esphome@^3.4.0
    marian-craciunescu/ESP32Ping@^1.7

build_flags_base = 
    -Isrc
    -std=gnu++17
    -DASYNC_TCP_SSL_ENABLED=0
    -DCONFIG_ASYNC_TCP_MAX_ACK_TIME=3000
    -DCONFIG_ASYNC_TCP_PRIORITY=10
    -DCONFIG_ASYNC_TCP_QUEUE_SIZE=8
    -DASYNCWEBSERVER_REGEX=1
    -DDISABLE_OTA=1
    -DARDUINOJSON_USE_LONG_LONG=0

build_unflags_base = 
    -O2
    -std=gnu++11

; CORE_DEBUG_LEVEL: 0=None, 1=Error, 2=Warn, 3=Info, 4=Debug, 5=Verbose

; Release optimization profile
build_flags_release =
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_ERROR
    -DAPP_LOG_LEVEL=LOG_LEVEL_ERROR
    -DRELEASE_BUILD=1

; Debug profile
build_flags_debug =
    -O0
    -g3
    -ggdb
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_INFO
    -DAPP_LOG_LEVEL=LOG_LEVEL_VERBOSE

; ========================================
; BASE ENVIRONMENTS
; ========================================

[env:esp32c3_base]
platform = espressif32@^6.9.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
board_build.filesystem = littlefs
board_build.partitions = partitions_4mb_no_ota.csv
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_HAS_PSRAM=0
    -DBOARD_ESP32C3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; FastLED RMT driver configuration for ESP32-C3 (4 RMT channels)
    ; MAX_CHANNELS=1: Conservative, single LED strip, prevents conflicts
    ; BUILTIN_DRIVER=1: Use stable ESP-IDF RMT driver (prevents crashes)
    -DFASTLED_RMT_MAX_CHANNELS=1
    -DFASTLED_RMT_BUILTIN_DRIVER=1
build_unflags = ${common.build_unflags_base}

[env:esp32s3_base]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions_8mb_ota.csv
board_build.flash_mode = dio
board_upload.flash_size = 8MB
; No PSRAM on custom PCB (8MB Flash only)
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_HAS_PSRAM=0
    -DBOARD_ESP32S3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; FastLED RMT driver configuration for ESP32-S3 (4 TX + 4 RX channels)
    ; MAX_CHANNELS=1: Conservative, single LED strip, prevents conflicts
    ; BUILTIN_DRIVER=1: Use stable ESP-IDF RMT driver (prevents crashes)
    -DFASTLED_RMT_MAX_CHANNELS=1
    -DFASTLED_RMT_BUILTIN_DRIVER=1
build_unflags = ${common.build_unflags_base}

[env:esp32s3_4mb_base]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions_4mb_no_ota.csv
board_build.flash_mode = dio
board_upload.flash_size = 4MB
; PSRAM configuration for ESP32-S3R8 (4MB Flash + 2MB PSRAM)
board_build.arduino.memory_type = qio_qspi
board_build.psram_type = qio
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_HAS_PSRAM=1
    -DBOARD_ESP32S3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; FastLED RMT driver configuration for ESP32-S3 (4 TX + 4 RX channels)
    ; MAX_CHANNELS=1: Conservative, single LED strip, prevents conflicts
    ; BUILTIN_DRIVER=1: Use stable ESP-IDF RMT driver (prevents crashes)
    -DFASTLED_RMT_MAX_CHANNELS=1
    -DFASTLED_RMT_BUILTIN_DRIVER=1
build_unflags = ${common.build_unflags_base}

; ========================================
; PRODUCTION BUILD ENVIRONMENTS
; ========================================

[env:c3-4mb-prod]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_release}
    ; LEDs disabled on ESP32-C3 - FastLED.show() crashes on this platform
    ; Root cause: FastLED library has broken ESP32-C3 support
    ; Crash happens inside CFastLED::show() regardless of driver configuration
    ; Works fine on ESP32-S3 variants
    -DENABLE_LEDS=0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:s3-4mb-prod]
extends = env:esp32s3_4mb_base
lib_deps =
    ${env:esp32s3_4mb_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_4mb_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

; ========================================
; DEVELOPMENT ENVIRONMENT
; ========================================

[env:c3-4mb-dev]
extends = env:esp32c3_base
upload_port = /dev/cu.usbmodem134401
monitor_port = /dev/cu.usbmodem134401
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    ; Testing: LEDs enabled to identify actual crash cause
    ; Minimal test shows FastLED + AsyncWebServer + MQTT work fine
    ; If crash still happens, it's interaction with other components
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

[env:s3-4mb-dev]
extends = env:esp32s3_4mb_base
upload_port = /dev/cu.usbmodem134301
monitor_port = /dev/cu.usbmodem134301
lib_deps =
    ${env:esp32s3_4mb_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_4mb_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

; ========================================
; CUSTOM PCB ENVIRONMENTS (with eFuse protection)
; ========================================

[env:s3-pcb-prod]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_release}
    -DBOARD_ESP32S3_CUSTOM_PCB
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:s3-pcb-dev]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_debug}
    -DBOARD_ESP32S3_CUSTOM_PCB
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

; ========================================
; TEST ENVIRONMENT
; ========================================

[env:c3-mqtt-poc]
extends = env:esp32c3_base
upload_port = /dev/cu.usbmodem134401
monitor_port = /dev/cu.usbmodem134401
lib_deps =
    ${env:esp32c3_base.lib_deps}
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=0
build_src_filter =
    +<../test/test_mqtt_poc.cpp>
    +<config/>
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0

[env:c3-4mb-test]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DARDUINO_JSON_USE_DOUBLE=0
    -DENABLE_LEDS=1
    -Wl,--gc-sections
build_src_filter = +<*> -<main.cpp>
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
upload_speed = 115200
test_framework = unity
test_speed = 115200
test_filter = *
test_build_src = yes
test_ignore = test_integration_*
debug_test = *
debug_build_flags = -O0 -g3 -ggdb

; ========================================
; MINIMAL PRINTER TEST ENVIRONMENT
; ========================================

[env:s3-printer-test]
extends = env:esp32s3_4mb_base
lib_deps =
    ${env:esp32s3_4mb_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_4mb_base.build_flags}
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_VERBOSE
    -DENABLE_LEDS=1
    -O0
    -g3
    -ggdb
build_src_filter = +<*> -<main.cpp> +<../test_main.cpp>
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0

; ========================================
; ESP32-C3 FASTLED MINIMAL TEST
; ========================================
; Minimal isolated test to confirm FastLED crashes on ESP32-C3
; No AsyncWebServer, no MQTT, no config - just FastLED.show()

[env:c3-fastled-test]
extends = env:esp32c3_base
lib_deps =
    fastled/FastLED@^3.10.3
    esphome/AsyncTCP-esphome@^2.1.4
    esphome/ESPAsyncWebServer-esphome@^3.4.0
    ropg/ezTime@^0.8.3
    bblanchon/ArduinoJson@^7.4.0
build_flags =
    ${env:esp32c3_base.build_flags}
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_INFO
    -DLOG_LEVEL=LOG_LEVEL_NOTICE
    -DASYNC_TCP_SSL_ENABLED=0
    -DCONFIG_ASYNC_TCP_MAX_ACK_TIME=3000
    -DCONFIG_ASYNC_TCP_PRIORITY=10
    -DCONFIG_ASYNC_TCP_QUEUE_SIZE=8
    -DASYNCWEBSERVER_REGEX=1
    -DENABLE_LEDS=1
    -O0
    -g3
    -ggdb
build_src_filter =
    +<../test/test_c3_fastled.cpp>
    +<leds/>
    +<core/>
    +<config/>
    +<utils/>
    +<hardware/>
    +<web/>
    +<content/>
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
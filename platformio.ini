[platformio]
default_envs = esp32c3-4mb-prod, esp32s3-8mb-prod, esp32s3-4mb-prod

; ========================================
; COMMON CONFIGURATION
; ========================================

[common]
lib_deps_base =
    arduino-libraries/NTPClient@^3.2.1
    ropg/ezTime@^0.8.3
    bblanchon/ArduinoJson@^7.4.2
    knolleary/PubSubClient@^2.8
    thijse/ArduinoLog@^1.1.1
    esphome/AsyncTCP-esphome@^2.1.4
    esphome/ESPAsyncWebServer-esphome@^3.4.0

build_flags_base = 
    -Isrc
    -std=gnu++17
    -DBOARD_HAS_PSRAM=0
    -DASYNC_TCP_SSL_ENABLED=0
    -DCONFIG_ASYNC_TCP_MAX_ACK_TIME=3000
    -DCONFIG_ASYNC_TCP_PRIORITY=10
    -DCONFIG_ASYNC_TCP_QUEUE_SIZE=32
    -DASYNCWEBSERVER_REGEX=1
    -DDISABLE_OTA=1
    -DARDUINOJSON_USE_LONG_LONG=0

build_unflags_base = 
    -O2
    -std=gnu++11

; CORE_DEBUG_LEVEL: 0=None, 1=Error, 2=Warn, 3=Info, 4=Debug, 5=Verbose

; Release optimization profile
build_flags_release =
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_ERROR
    -DRELEASE_BUILD=1

; Debug profile
build_flags_debug =
    -O0
    -g3
    -ggdb
    -DCORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_INFO

; ========================================
; BASE ENVIRONMENTS
; ========================================

[env:esp32c3_base]
platform = espressif32@^6.9.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
board_build.filesystem = littlefs
board_build.partitions = partitions_4mb_no_ota.csv
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_ESP32C3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
build_unflags = ${common.build_unflags_base}

[env:esp32s3_base]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions_8mb_ota.csv
board_build.flash_mode = dio
board_upload.flash_size = 8MB
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_ESP32S3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DFASTLED_RMT_MAX_CHANNELS=1
    -DFASTLED_RMT_BUILTIN_DRIVER=1
build_unflags = ${common.build_unflags_base}

[env:esp32s3_4mb_base]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.filesystem = littlefs
board_build.partitions = partitions_4mb_no_ota.csv
board_build.flash_mode = dio
board_upload.flash_size = 4MB
lib_deps = ${common.lib_deps_base}
build_flags =
    ${common.build_flags_base}
    -DBOARD_ESP32S3_MINI
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DFASTLED_RMT_MAX_CHANNELS=1
    -DFASTLED_RMT_BUILTIN_DRIVER=1
build_unflags = ${common.build_unflags_base}

; ========================================
; PRODUCTION BUILD ENVIRONMENTS
; ========================================

[env:esp32c3-4mb-prod]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:esp32s3-8mb-prod]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:esp32s3-4mb-prod]
extends = env:esp32s3_4mb_base
lib_deps =
    ${env:esp32s3_4mb_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_4mb_base.build_flags}
    ${common.build_flags_release}
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

; ========================================
; DEVELOPMENT ENVIRONMENT
; ========================================

[env:esp32c3-4mb-dev]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

[env:esp32s3-8mb-dev]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

[env:esp32s3-4mb-dev]
extends = env:esp32s3_4mb_base
lib_deps =
    ${env:esp32s3_4mb_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_4mb_base.build_flags}
    ${common.build_flags_debug}
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

; ========================================
; CUSTOM PCB ENVIRONMENTS (with eFuse protection)
; ========================================

[env:esp32s3-8mb-custom-pcb-prod]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_release}
    -DBOARD_ESP32S3_CUSTOM_PCB
    -DENABLE_LEDS=1
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py

[env:esp32s3-8mb-custom-pcb-dev]
extends = env:esp32s3_base
lib_deps =
    ${env:esp32s3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32s3_base.build_flags}
    ${common.build_flags_debug}
    -DBOARD_ESP32S3_CUSTOM_PCB
    -DENABLE_LEDS=1
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
extra_scripts =
    pre:scripts/pio/generate_config_example.py
    pre:scripts/pio/build_frontend.py
    scripts/pio/build_upload_monitor.py

; ========================================
; TEST ENVIRONMENT
; ========================================

[env:esp32c3-4mb-test]
extends = env:esp32c3_base
lib_deps =
    ${env:esp32c3_base.lib_deps}
    fastled/FastLED@^3.10.3
build_flags =
    ${env:esp32c3_base.build_flags}
    ${common.build_flags_debug}
    -DARDUINO_JSON_USE_DOUBLE=0
    -DENABLE_LEDS=1
    -Wl,--gc-sections
build_src_filter = +<*> -<main.cpp>
monitor_filters =
    esp32_exception_decoder
    colorize
monitor_rts = 0
monitor_dtr = 0
upload_speed = 115200
test_framework = unity
test_speed = 115200
test_filter = *
test_build_src = yes
test_ignore = test_integration_*
debug_test = *
debug_build_flags = -O0 -g3 -ggdb
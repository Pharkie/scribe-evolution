<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Settings - Scribe Evolution</title>

    
    <link rel="preload" as="font" type="font/woff2" href="/fonts/outfit-variable.woff2" crossorigin>

    <!-- CSS Assets -->
    <link rel="stylesheet" href="/css/app.css">

    <!-- Common JS -->
    <script src="/js/app-common.js"></script>

    <!-- MQTT page bundle (includes settings-api) -->
    <script src="/js/page-settings-mqtt.js"></script>

    <!-- Alpine.js (load last) -->
    <script defer src="/js/alpine.js"></script>
</head>

<body
    class="flex flex-col min-h-screen justify-between py-8 px-4 font-sans bg-gray-50 dark:bg-gray-900 transition-colors duration-200"
    x-data="$store.settingsMqtt" x-init="loadConfiguration()">
    <main class="w-full max-w-4xl mx-auto flex-1">
        <!-- Header with title and back button -->
        <header class="w-full max-w-6xl mx-auto flex items-center mb-6 gap-4">
            <!-- Back button -->
            <div class="flex-1 flex justify-start">
                <a href="/settings/"
                    class="inline-flex items-center space-x-1 px-2 py-1.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 rounded-full transition-all duration-200 hover:scale-105 hover:shadow-md">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    <span class="text-xs sm:text-sm font-medium">Settings</span>
                </a>
            </div>

            <!-- Centered title with MQTT icon -->
            <div class="flex-1 flex justify-center">
                <h1
                    class="text-2xl sm:text-3xl lg:text-4xl font-normal text-gray-800 dark:text-gray-100 flex items-center space-x-1 sm:space-x-2 whitespace-nowrap">
                    <svg class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" 
                            d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46">
                        </path>
                    </svg>
                    <span>MQTT Settings</span>
                </h1>
            </div>

            <!-- Right spacer -->
            <div class="flex-1"></div>
        </header>


        <!-- Error State -->
        <div x-show="error"
            class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 mb-6"
            x-transition>
            <div class="text-center">
                <svg class="w-10 h-10 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z">
                    </path>
                </svg>
                <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">Configuration Loading Error</h3>
                <p class="text-red-600 dark:text-red-300 mb-4" x-text="error"></p>
                <p class="text-sm text-red-500 dark:text-red-400">Please check the system and try refreshing the page.
                </p>
                <button @click="window.location.reload()"
                    class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                    Retry
                </button>
            </div>
        </div>

        <!-- MQTT Settings Form -->
        <template x-if="loaded && !error">
            <div x-data="{ show: false }" x-init="$nextTick(() => show = true)" x-show="show" x-transition.opacity.duration.300ms>

                <!-- MQTT Configuration Card -->
                <div
                    class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl rounded-2xl p-6 border-t-3 border-yellow-600 transition-shadow duration-200">
                    <h2 class="text-2xl font-bold mb-6 text-yellow-600 dark:text-yellow-400">MQTT</h2>

                    <div class="space-y-6">

                        <!-- Enable/Disable Toggle -->
                        <div
                            class="flex items-center justify-between p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl border border-yellow-200 dark:border-yellow-800">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Enable MQTT</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Enable remote printing and device discovery
                                    </p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" x-model="config.mqtt.enabled">
                                <div
                                    class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 dark:peer-focus:ring-yellow-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white dark:after:bg-gray-200 after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-yellow-600 dark:peer-checked:bg-yellow-500">
                                </div>
                            </label>
                        </div>

                        <!-- MQTT Configuration (hidden when disabled) -->
                        <div x-show="config.mqtt.enabled" x-transition class="space-y-6">

                            <!-- MQTT Server - Full width row -->
                            <div class="space-y-2">
                                <label for="mqtt-server"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">MQTT
                                    Server:</label>
                                <input id="mqtt-server" type="text"
                                    placeholder="Enter MQTT broker address (e.g., broker.hivemq.com)"
                                    class="block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                                    x-model="config.mqtt.server" @input="resetMqttTestState()"
                                    @blur="validateServer($event.target.value)">
                                <p x-show="validation.errors['mqtt.server']"
                                    class="text-xs text-red-600 dark:text-red-400"
                                    x-text="validation.errors['mqtt.server']"></p>
                            </div>

                            <!-- Username, Password, Port - Three columns on desktop -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label for="mqtt-username"
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">MQTT
                                        Username:</label>
                                    <input id="mqtt-username" type="text" placeholder="Enter MQTT username"
                                        class="block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                                        x-model="config.mqtt.username" @input="resetMqttTestState()"
                                        @blur="validateUsername($event.target.value)">
                                    <p x-show="validation.errors['mqtt.username']"
                                        class="text-xs text-red-600 dark:text-red-400"
                                        x-text="validation.errors['mqtt.username']"></p>
                                </div>
                                <div class="space-y-2">
                                    <label for="mqtt-password"
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">MQTT
                                        Password:</label>
                                    <input type="password" id="mqtt-password" placeholder="Enter MQTT password"
                                        class="block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                                        x-model="config.mqtt.password"
                                        @focus="clearPasswordFieldOnFocus()"
                                        @input="trackMqttPasswordChange($event.target.value); resetMqttTestState()"
                                        @blur="validatePassword($event.target.value)">
                                    <p x-show="validation.errors['mqtt.password']" class="text-xs text-red-600 dark:text-red-400" x-text="validation.errors['mqtt.password']"></p>
                                </div>
                                <div class="space-y-2">
                                    <label for="mqtt-port"
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">MQTT
                                        Port:</label>
                                    <input type="number" id="mqtt-port" min="1" max="65535" placeholder="1883"
                                        class="block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                                        x-model.number="config.mqtt.port" @input="resetMqttTestState()"
                                        @blur="validatePort($event.target.value)">
                                    <p x-show="validation.errors['mqtt.port']"
                                        class="text-xs text-red-600 dark:text-red-400"
                                        x-text="validation.errors['mqtt.port']"></p>
                                </div>
                            </div>

                            <!-- Test Connection Button -->
                            <div class="flex justify-center">
                                <button type="button"
                                    class="px-6 py-3 bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/30 dark:hover:bg-yellow-900/40 text-yellow-800 dark:text-yellow-200 border border-yellow-300 dark:border-yellow-700 rounded-xl font-medium transition-all duration-200 hover:scale-105 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                    :disabled="mqttTesting || !config.mqtt.server || !config.mqtt.port || !hasChanges()"
                                    @click="testMqttConnection()" x-text="testButtonLabel">
                                    Test Connection
                                </button>
                            </div>


                        </div> <!-- End MQTT Configuration -->
                    </div>

                </div>

                <!-- MQTT Warning Banner -->
                <div x-show="config.mqtt?.enabled && !mqttTestPassed"
                    class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6 mt-6" x-transition>
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mr-2" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z">
                            </path>
                        </svg>
                        <div class="text-sm">
                            <span class="font-medium text-yellow-800 dark:text-yellow-200">Please test MQTT
                                connection before saving</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-center gap-8 pt-6">
                    <button type="button" @click="saveConfig()" :disabled="saving || !canSave"
                        class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-lg py-4 px-6 rounded-xl transition-all duration-200 hover:scale-[1.02] hover:shadow-xl transform active:scale-95 shadow-lg"
                        :class="{ 'opacity-50 cursor-not-allowed': saving || !canSave }"
                        :title="!canSave ? (config.mqtt?.enabled && !mqttTestPassed ? 'Please test MQTT connection before saving' : 'Please fill in all required fields to save') : ''">
                        <span x-show="!saving" class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            Save MQTT Settings
                        </span>
                        <span x-show="saving" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            Saving...
                        </span>
                    </button>
                    <button type="button" @click="cancelConfiguration"
                        class="sm:flex-initial sm:w-32 text-gray-700 dark:text-gray-300 py-3 px-4 rounded-xl font-medium transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-300 dark:border-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </template>
    </main>

</body>

</html>
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Button Settings - Scribe Evolution</title>

    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/fonts/outfit-variable.woff2"
      crossorigin
    />

    <!-- CSS Assets -->
    <link rel="stylesheet" href="/css/app.css" />

    <!-- Common JS -->
    <script src="/js/app-common.js"></script>

    <!-- Button page bundle (includes settings-api) -->
    <script src="/js/page-settings-buttons.js"></script>

    <!-- Alpine.js (load last) -->
    <script defer src="/js/alpine.js"></script>
  </head>

  <body
    class="flex flex-col min-h-screen justify-between py-8 px-4 font-sans bg-gray-50 dark:bg-gray-900 transition-colors duration-200"
    x-data="$store.settingsButtons"
    x-init="loadConfiguration()"
  >
    <main class="w-full max-w-4xl mx-auto flex-1">
      <!-- Header with title and back button -->
      <header class="w-full max-w-6xl mx-auto flex items-center mb-6 gap-4">
        <!-- Back button -->
        <div class="flex-1 flex justify-start">
          <a
            href="/settings/"
            class="inline-flex items-center space-x-1 px-2 py-1.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 rounded-full transition-all duration-200 hover:scale-105 hover:shadow-md"
          >
            <svg
              class="w-3 h-3 sm:w-4 sm:h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
            <span class="text-xs sm:text-sm font-medium">Settings</span>
          </a>
        </div>

        <!-- Centered title with button icon -->
        <div class="flex-1 flex justify-center">
          <h1
            class="text-2xl sm:text-3xl lg:text-4xl font-normal text-gray-800 dark:text-gray-100 flex items-center space-x-1 sm:space-x-2 whitespace-nowrap"
          >
            <svg
              class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
              ></path>
            </svg>
            <span>Button Settings</span>
          </h1>
        </div>

        <!-- Right spacer -->
        <div class="flex-1"></div>
      </header>

      <!-- Error State -->
      <template x-if="loaded && error">
        <div
          class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 mb-6"
        >
          <div class="text-center">
            <svg
              class="w-10 h-10 mb-4 mx-auto"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
              ></path>
            </svg>
            <h3
              class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2"
            >
              Configuration Loading Error
            </h3>
            <p class="text-red-600 dark:text-red-300 mb-4" x-text="error"></p>
            <p class="text-sm text-red-500 dark:text-red-400">
              Please check the system and try refreshing the page.
            </p>
            <button
              @click="window.location.reload()"
              class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 cursor-pointer"
            >
              Retry
            </button>
          </div>
        </div>
      </template>

      <!-- Button Settings Form -->
      <template x-if="loaded && !error">
        <div
          x-data="{ show: false }"
          x-init="$nextTick(() => show = true)"
          x-show="show"
          x-transition.opacity.duration.300ms
          class="space-y-6"
        >
          <form @submit.prevent="saveConfiguration" class="space-y-8">
            <!-- Button Actions Section -->
            <div
              class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl rounded-2xl p-6 border-t-3 border-cyan-600 transition-shadow duration-200"
            >
              <h2
                class="text-2xl font-bold mb-6 flex items-center space-x-2 text-cyan-600 dark:text-cyan-400"
              >
                Button Actions
              </h2>

              <div class="space-y-6">
                <template x-for="buttonNum in [1, 2, 3, 4]" :key="buttonNum">
                  <div class="p-4 bg-cyan-50 dark:bg-cyan-900/20 rounded-xl">
                    <h3
                      class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4"
                    >
                      <span x-text="`Button ${buttonNum}`"></span>
                      <span
                        class="text-sm font-normal text-gray-600 dark:text-gray-400"
                      >
                        (GPIO
                        <span
                          x-text="(config.buttons[`button${buttonNum}`]?.gpio === -1 || !config.buttons[`button${buttonNum}`]?.gpio) ? 'Not connected' : config.buttons[`button${buttonNum}`].gpio"
                        ></span
                        >)
                      </span>
                    </h3>

                    <!-- Short Press Section -->
                    <div class="mb-6">
                      <h4
                        class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center"
                      >
                        <svg
                          class="w-4 h-4 mr-2 text-cyan-700 dark:text-cyan-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m19.5 8.25-7.5 7.5-7.5-7.5"
                          ></path>
                        </svg>
                        Short Press
                      </h4>
                      <div
                        class="grid grid-cols-1 gap-4"
                        :class="config?.leds?.enabled ? 'md:grid-cols-3' : 'md:grid-cols-2'"
                      >
                        <!-- Action -->
                        <div class="space-y-2">
                          <label
                            :for="`button${buttonNum}-short`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            Action
                          </label>
                          <select
                            :id="`button${buttonNum}-short`"
                            class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm"
                            x-model="config.buttons[`button${buttonNum}`].shortAction"
                          >
                            <option value="">None</option>
                            <option value="JOKE">Joke</option>
                            <option value="RIDDLE">Riddle</option>
                            <option value="QUOTE">Quote</option>
                            <option value="QUIZ">Quiz</option>
                            <option value="NEWS">News</option>
                            <option value="CHARACTER_TEST">
                              Character Test
                            </option>
                            <option value="UNBIDDEN_INK">Unbidden Ink</option>
                            <option value="MEMO1">Memo 1</option>
                            <option value="MEMO2">Memo 2</option>
                            <option value="MEMO3">Memo 3</option>
                            <option value="MEMO4">Memo 4</option>
                          </select>
                        </div>

                        <!-- MQTT Topic -->
                        <div class="space-y-2">
                          <label
                            :for="`button${buttonNum}-short-mqtt`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            MQTT Topic
                          </label>
                          <input
                            :id="`button${buttonNum}-short-mqtt`"
                            type="text"
                            placeholder="Optional (leave blank for local)"
                            class="w-full p-3 rounded-lg border text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 transition-colors"
                            :class="validationErrors[`mqtt-${buttonNum}-short`] ? 'border-red-400 focus:ring-red-400 focus:border-red-400' : 'border-gray-200 dark:border-gray-600 focus:ring-cyan-400 focus:border-transparent'"
                            x-model="config.buttons[`button${buttonNum}`].shortMqttTopic"
                            @blur="validateMqttTopic($event.target.value, buttonNum, 'short')"
                          />
                          <p
                            x-show="validationErrors[`mqtt-${buttonNum}-short`]"
                            class="text-xs text-red-600 dark:text-red-400 mt-1"
                            x-text="validationErrors[`mqtt-${buttonNum}-short`]"
                          ></p>
                        </div>

                        <!-- LED Effect (only show if LEDs enabled) -->
                        <div class="space-y-2" x-show="config?.leds?.enabled">
                          <label
                            :for="`button${buttonNum}-short-led`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            LED Effect
                          </label>
                          <select
                            :id="`button${buttonNum}-short-led`"
                            class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm"
                            x-model="config.buttons[`button${buttonNum}`].shortLedEffect"
                          >
                            <option value="chase_single">
                              Default (Chase Single - Green)
                            </option>
                            <option value="chase_multi">
                              Chase (Multiple Colors)
                            </option>
                            <option value="rainbow">Rainbow</option>
                            <option value="twinkle">Twinkle</option>
                            <option value="pulse">Pulse</option>
                            <option value="matrix">Matrix</option>
                            <option value="none">No Effect</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <!-- Long Press Section -->
                    <div>
                      <h4
                        class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center"
                      >
                        <svg
                          class="w-4 h-4 mr-2 text-cyan-700 dark:text-cyan-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5"
                          ></path>
                        </svg>
                        Long Press
                      </h4>
                      <div
                        class="grid grid-cols-1 gap-4"
                        :class="config?.leds?.enabled ? 'md:grid-cols-3' : 'md:grid-cols-2'"
                      >
                        <!-- Action -->
                        <div class="space-y-2">
                          <label
                            :for="`button${buttonNum}-long`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            Action
                          </label>
                          <select
                            :id="`button${buttonNum}-long`"
                            class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm"
                            x-model="config.buttons[`button${buttonNum}`].longAction"
                          >
                            <option value="">None</option>
                            <option value="JOKE">Joke</option>
                            <option value="RIDDLE">Riddle</option>
                            <option value="QUOTE">Quote</option>
                            <option value="QUIZ">Quiz</option>
                            <option value="NEWS">News</option>
                            <option value="CHARACTER_TEST">
                              Character Test
                            </option>
                            <option value="UNBIDDEN_INK">Unbidden Ink</option>
                            <option value="MEMO1">Memo 1</option>
                            <option value="MEMO2">Memo 2</option>
                            <option value="MEMO3">Memo 3</option>
                            <option value="MEMO4">Memo 4</option>
                          </select>
                        </div>

                        <!-- MQTT Topic -->
                        <div class="space-y-2">
                          <label
                            :for="`button${buttonNum}-long-mqtt`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            MQTT Topic
                          </label>
                          <input
                            :id="`button${buttonNum}-long-mqtt`"
                            type="text"
                            placeholder="Optional (leave blank for local)"
                            class="w-full p-3 rounded-lg border text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 transition-colors"
                            :class="validationErrors[`mqtt-${buttonNum}-long`] ? 'border-red-400 focus:ring-red-400 focus:border-red-400' : 'border-gray-200 dark:border-gray-600 focus:ring-cyan-400 focus:border-transparent'"
                            x-model="config.buttons[`button${buttonNum}`].longMqttTopic"
                            @blur="validateMqttTopic($event.target.value, buttonNum, 'long')"
                          />
                          <p
                            x-show="validationErrors[`mqtt-${buttonNum}-long`]"
                            class="text-xs text-red-600 dark:text-red-400 mt-1"
                            x-text="validationErrors[`mqtt-${buttonNum}-long`]"
                          ></p>
                        </div>

                        <!-- LED Effect (only show if LEDs enabled) -->
                        <div class="space-y-2" x-show="config?.leds?.enabled">
                          <label
                            :for="`button${buttonNum}-long-led`"
                            class="block text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide"
                          >
                            LED Effect
                          </label>
                          <select
                            :id="`button${buttonNum}-long-led`"
                            class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700 text-sm"
                            x-model="config.buttons[`button${buttonNum}`].longLedEffect"
                          >
                            <option value="chase_single">
                              Default (Chase Single - Green)
                            </option>
                            <option value="chase_multi">
                              Chase (Multiple Colors)
                            </option>
                            <option value="rainbow">Rainbow</option>
                            <option value="twinkle">Twinkle</option>
                            <option value="pulse">Pulse</option>
                            <option value="matrix">Matrix</option>
                            <option value="none">No Effect</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- Button Technicals (Read-only) -->
                <div
                  class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl p-4"
                >
                  <div class="flex items-center mb-4">
                    <svg
                      class="w-6 h-6 mr-2 text-gray-600 dark:text-gray-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M21.75 6.75a4.5 4.5 0 0 1-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 1 1-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 0 1 6.336-4.486l-3.276 3.276a3.004 3.004 0 0 0 2.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852Z"
                      ></path>
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4.867 19.125h.008v.008h-.008v-.008Z"
                      ></path>
                    </svg>
                    <span
                      class="text-lg font-semibold text-gray-800 dark:text-gray-100"
                      >Button Technicals</span
                    >
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="space-y-2">
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Button Count:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="config.buttons?.count || '-'"
                        ></span>
                      </div>
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Debounce Time:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="(config.buttons?.debounceTime || '-') + (config.buttons?.debounceTime ? ' ms' : '')"
                        ></span>
                      </div>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Long Press Time:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="(config.buttons?.longPressTime || '-') + (config.buttons?.longPressTime ? ' ms' : '')"
                        ></span>
                      </div>
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Active Low:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="config.buttons?.activeLow ? 'Yes' : (config.buttons?.activeLow === false ? 'No' : '-')"
                        ></span>
                      </div>
                    </div>
                    <div class="space-y-2">
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Min Interval:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="(config.buttons?.minInterval || '-') + (config.buttons?.minInterval ? ' ms' : '')"
                        ></span>
                      </div>
                      <div>
                        <span
                          class="font-medium text-gray-700 dark:text-gray-300"
                          >Maximum presses per minute:</span
                        >
                        <span
                          class="text-gray-800 dark:text-gray-200"
                          x-text="config.buttons?.maxPerMinute || '-'"
                        ></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center gap-8 pt-6">
              <button
                type="submit"
                :disabled="!canSave"
                class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-lg py-4 px-6 rounded-xl transition-all duration-200 hover:scale-[1.02] hover:shadow-xl transform active:scale-95 shadow-lg cursor-pointer"
                :class="{ 'opacity-50 cursor-not-allowed': !canSave }"
              >
                <span x-show="!saving" class="flex items-center justify-center">
                  <svg
                    class="w-5 h-5 mr-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    ></path>
                  </svg>
                  Save Button Settings
                </span>
                <span
                  x-show="saving"
                  class="flex items-center justify-center space-x-2"
                >
                  <div
                    class="animate-spin rounded-full border-2 border-white border-t-transparent w-5 h-5"
                  ></div>
                  <span>Saving...</span>
                </span>
              </button>
              <button
                type="button"
                @click="cancelConfiguration"
                class="sm:flex-initial sm:w-32 text-gray-700 dark:text-gray-300 py-3 px-4 rounded-xl font-medium transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-300 dark:border-gray-600 cursor-pointer"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </template>
    </main>
  </body>
</html>

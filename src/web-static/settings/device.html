<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Device Settings - Scribe Evolution</title>

    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="/fonts/outfit-variable.woff2"
      crossorigin
    />

    <!-- CSS Assets -->
    <link rel="stylesheet" href="/css/app.css" />

    <!-- Common JS -->
    <script src="/js/app-common.js"></script>

    <!-- Device page bundle (includes settings-api) -->
    <script src="/js/page-settings-device.js"></script>

    <!-- Alpine.js (load last) -->
    <script defer src="/js/alpine.js"></script>
  </head>

  <body
    class="flex flex-col min-h-screen justify-between py-8 px-4 font-sans bg-gray-50 dark:bg-gray-900 transition-colors duration-200"
    x-data="$store.settingsDevice"
    x-init="loadConfiguration()"
  >
    <main class="w-full max-w-4xl mx-auto flex-1">
      <!-- Header with title and back button -->
      <header class="w-full max-w-6xl mx-auto flex items-center mb-6 gap-4">
        <!-- Back button -->
        <div class="flex-1 flex justify-start">
          <a
            href="/settings/"
            class="inline-flex items-center space-x-1 px-2 py-1.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 rounded-full transition-all duration-200 hover:scale-105 hover:shadow-md"
          >
            <svg
              class="w-3 h-3 sm:w-4 sm:h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
            <span class="text-xs sm:text-sm font-medium">Settings</span>
          </a>
        </div>

        <!-- Centered title with device icon -->
        <div class="flex-1 flex justify-center">
          <h1
            class="text-2xl sm:text-3xl lg:text-4xl font-normal text-gray-800 dark:text-gray-100 flex items-center space-x-1 sm:space-x-2 whitespace-nowrap"
          >
            <svg
              class="w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-16.5 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z"
              ></path>
            </svg>
            <span>Device Settings</span>
          </h1>
        </div>

        <!-- Right spacer -->
        <div class="flex-1"></div>
      </header>

      <!-- Error State -->
      <template x-if="loaded && error">
        <div
          class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 mb-6"
        >
          <div class="text-center">
            <svg
              class="w-10 h-10 mb-4 mx-auto text-red-600 dark:text-red-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
              ></path>
            </svg>
            <h3
              class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2"
            >
              Configuration Loading Error
            </h3>
            <p class="text-red-600 dark:text-red-300 mb-4" x-text="error"></p>
            <p class="text-sm text-red-500 dark:text-red-400">
              Please check the system and try refreshing the page.
            </p>
            <button
              @click="window.location.reload()"
              class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200 cursor-pointer"
            >
              Retry
            </button>
          </div>
        </div>
      </template>

      <!-- Device Settings Form -->
      <template x-if="loaded && !error">
        <div
          x-data="{ show: false }"
          x-init="$nextTick(() => show = true)"
          x-show="show"
          x-transition.opacity.duration.300ms
          class="space-y-6"
        >
          <form @submit.prevent="saveConfiguration" class="space-y-8">
            <!-- Device Identity Section -->
            <div
              class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl rounded-2xl p-6 border-t-3 border-blue-600 transition-shadow duration-200"
            >
              <h2
                class="text-2xl font-bold mb-6 flex items-center space-x-2 text-blue-600 dark:text-blue-400"
              >
                Device Identity
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Device Owner -->
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Device Owner:</label
                  >
                  <input
                    type="text"
                    x-model="config.device.owner"
                    @blur="validateDeviceOwner($event.target.value)"
                    class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700"
                    placeholder="Enter device owner name"
                    required
                  />
                  <p
                    x-show="validation.errors['device.owner']"
                    class="text-xs text-red-600 dark:text-red-400 mt-1"
                    x-text="validation.errors['device.owner']"
                  ></p>
                  <p
                    x-show="!validation.errors['device.owner']"
                    class="text-xs text-gray-500 dark:text-gray-400 mt-2"
                  >
                    If you change the device owner, the mDNS hostname will
                    change on restart and you'll need to connect to the new
                    address
                  </p>
                </div>

                <!-- Timezone Picker -->
                <div
                  x-data="{ isOpen: false, searchQuery: '', focusedIndex: -1 }"
                  @timezone-picker-open="openTimezonePicker()"
                  @keydown.window="handleGlobalKeydown($event, $refs)"
                  class="relative"
                >
                  <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Timezone:</label
                  >

                  <!-- Timezone Input/Dropdown Button -->
                  <div class="relative">
                    <input
                      type="text"
                      x-ref="searchInput"
                      x-model="searchQuery"
                      @click.stop="$dispatch('timezone-picker-open')"
                      @focus.stop="$dispatch('timezone-picker-open')"
                      @input="onSearchInputWithReset()"
                      @keydown.escape="closeTimezonePicker()"
                      @keydown.down.prevent="navigateToFirstTimezone($refs, $nextTick)"
                      @keydown.up.prevent="navigateToLastTimezone($refs, $nextTick)"
                      class="w-full p-3 pr-10 rounded-xl border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-700"
                      placeholder="Search timezones (e.g., New York, London, UTC)"
                      autocomplete="off"
                    />

                    <!-- Dropdown Arrow -->
                    <div
                      class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                    >
                      <svg
                        class="w-5 h-5 text-gray-400 dark:text-gray-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="m19 9-7 7-7-7"
                        ></path>
                      </svg>
                    </div>
                  </div>

                  <!-- Dropdown Menu -->
                  <div
                    x-show="isOpen"
                    x-ref="dropdown"
                    @click.away="closeTimezonePicker()"
                    class="absolute z-50 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl shadow-xl mt-1"
                  >
                    <!-- No Results -->
                    <div
                      x-show="filteredTimezones.length === 0"
                      class="p-3 text-center text-gray-500 dark:text-gray-400 text-sm"
                    >
                      No timezones found for "<span x-text="searchQuery"></span
                      >"
                    </div>

                    <!-- Timezone Options -->
                    <template
                      x-for="(timezone, index) in filteredTimezones.slice(0, 5)"
                      :key="timezone.id"
                    >
                      <button
                        type="button"
                        tabindex="0"
                        data-timezone-option
                        class="w-full text-left px-4 py-3 focus:outline-none transition-colors duration-150"
                        :class="{
                                                'border-b border-gray-100 dark:border-gray-700': filteredTimezones.length > 1 && index < Math.min(filteredTimezones.length, 5) - 1,
                                                'bg-blue-100 dark:bg-blue-900/50': focusedIndex === index
                                            }"
                        @click="selectTimezone(timezone)"
                        @mouseenter="focusedIndex = index; $el.focus()"
                        @mouseleave="resetTimezoneFocus()"
                        @focus="focusedIndex = index"
                        @keydown.escape="closeTimezonePicker()"
                        @keydown.enter.prevent="selectTimezone(timezone)"
                        @keydown.up.prevent="navigateTimezoneUp($refs, $nextTick)"
                        @keydown.down.prevent="navigateTimezoneDown($refs, $nextTick)"
                      >
                        <div class="flex flex-col">
                          <span
                            class="font-medium text-gray-900 dark:text-gray-100"
                            x-text="timezone.displayName"
                          ></span>
                          <div class="text-xs text-gray-500 dark:text-gray-400">
                            <div x-text="timezone.id"></div>
                            <div x-text="timezone.offset"></div>
                          </div>
                        </div>
                      </button>
                    </template>

                    <!-- Show More Results Indicator -->
                    <div
                      x-show="filteredTimezones.length > 5"
                      class="p-3 text-center text-xs text-gray-500 dark:text-gray-400 border-t border-gray-100 dark:border-gray-700"
                    >
                      Showing top 5 results. Continue typing to narrow search.
                    </div>
                  </div>

                  <!-- Selected Timezone Display -->
                  <div x-show="config.device.timezone && !isOpen" class="mt-2">
                    <div class="text-sm text-gray-600 dark:text-gray-300">
                      <div
                        class="font-medium"
                        x-text="getSelectedTimezoneDisplayName(config.device.timezone)"
                      ></div>
                      <div
                        class="text-xs mt-1"
                        x-text="getSelectedTimezoneOffset(config.device.timezone)"
                      ></div>
                    </div>
                  </div>

                  <!-- Validation Error -->
                  <p
                    x-show="validation.errors['device.timezone']"
                    class="text-xs text-red-600 dark:text-red-400 mt-1"
                    x-text="validation.errors['device.timezone']"
                  ></p>

                  <!-- Error Message -->
                  <p
                    x-show="timezonePicker.error && !validation.errors['device.timezone']"
                    class="text-xs text-red-600 dark:text-red-400 mt-1"
                    x-text="timezonePicker.error"
                  ></p>

                  <!-- Help Text -->
                  <p
                    x-show="!validation.errors['device.timezone'] && !timezonePicker.error"
                    class="text-xs text-gray-500 dark:text-gray-400 mt-2"
                  >
                    Search by city, country, or timezone name
                  </p>
                </div>
              </div>
            </div>

            <!-- GPIO Pins Section -->
            <div
              class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl rounded-2xl p-6 border-t-3 border-blue-600 transition-shadow duration-200"
            >
              <h2
                class="text-2xl font-bold mb-4 flex items-center space-x-2 text-blue-600 dark:text-blue-400"
              >
                GPIO Pins
              </h2>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                Select GPIO pin for your hardware. Each GPIO can only be
                assigned once.
              </p>

              <!-- GPIO Assignment Interface -->
              <div class="space-y-6">
                <!-- GPIO Pin Configuration Grid -->
                <div class="space-y-6">
                  <!-- First Row: Printer and LED Strip (conditional) -->
                  <div
                    class="grid grid-cols-1 gap-6"
                    :class="config.leds?.enabled ? 'sm:grid-cols-2' : 'sm:grid-cols-1'"
                  >
                    <!-- Printer Card -->
                    <div
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          Printer
                        </h4>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'printer-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.device.printerTxPin !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="printer-gpio"
                                :value="pin"
                                :checked="config.device.printerTxPin === pin"
                                :disabled="usedGpioPins.has(pin) && config.device.printerTxPin !== pin"
                                @change="config.device.printerTxPin = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.device.printerTxPin === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.device.printerTxPin !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.device.printerTxPin !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.device.printerTxPin === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <span
                                x-show="usedGpioPins.has(pin) && config.device.printerTxPin !== pin"
                                class="ml-1 text-xs text-gray-400 flex items-center"
                              >
                                <svg
                                  class="w-3 h-3 mr-1"
                                  fill="currentColor"
                                  viewBox="0 0 20 20"
                                >
                                  <path
                                    fill-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    clip-rule="evenodd"
                                  ></path>
                                </svg>
                              </span>
                            </label>
                          </template>
                        </div>

                        <!-- Disabled OFF option at bottom with tooltip -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-not-allowed opacity-60 mt-2"
                          title="Printer must have a GPIO pin assigned"
                        >
                          <input
                            type="radio"
                            name="printer-gpio"
                            value="-1"
                            disabled
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 border-gray-300 rounded-full mr-2"
                          ></div>
                          <span class="font-mono text-sm text-gray-400"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>

                    <!-- LED Strip Card (only show if LEDs enabled) -->
                    <div
                      x-show="config.leds?.enabled"
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg border-l-4 border-l-pink-600"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          LED Strip
                        </h4>
                        <p
                          class="text-xs text-amber-600 dark:text-amber-400 italic"
                        >
                          Changing LED pin requires a reboot to take effect
                        </p>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'led-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.leds?.pin !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="led-gpio"
                                :value="pin"
                                :checked="config.leds?.pin === pin"
                                :disabled="usedGpioPins.has(pin) && config.leds?.pin !== pin"
                                @change="config.leds.pin = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.leds?.pin === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.leds?.pin !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.leds?.pin !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.leds?.pin === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <span
                                x-show="usedGpioPins.has(pin) && config.leds?.pin !== pin"
                                class="ml-1 text-xs text-gray-400 flex items-center"
                              >
                                <svg
                                  class="w-3 h-3 mr-1"
                                  fill="currentColor"
                                  viewBox="0 0 20 20"
                                >
                                  <path
                                    fill-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    clip-rule="evenodd"
                                  ></path>
                                </svg>
                              </span>
                            </label>
                          </template>
                        </div>

                        <!-- OFF option at bottom -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 mt-2"
                        >
                          <input
                            type="radio"
                            name="led-gpio"
                            value="-1"
                            :checked="config.leds?.pin === -1"
                            @change="config.leds.pin = -1"
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                            :class="config.leds?.pin === -1 ? 'border-blue-600 bg-blue-600' : 'border-gray-400'"
                          ></div>
                          <span
                            class="font-mono text-sm"
                            :class="config.leds?.pin === -1 ? 'font-bold text-gray-900 dark:text-white' : 'text-gray-900 dark:text-white'"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Second Row: Button 1 and Button 2 -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- Button 1 Card -->
                    <div
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg border-l-4 border-l-cyan-600"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          Button 1
                        </h4>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'button1-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.buttons.button1?.gpio !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="button1-gpio"
                                :value="pin"
                                :checked="config.buttons.button1?.gpio === pin"
                                :disabled="usedGpioPins.has(pin) && config.buttons.button1?.gpio !== pin"
                                @change="config.buttons.button1.gpio = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.buttons.button1?.gpio === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.buttons.button1?.gpio !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.buttons.button1?.gpio !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.buttons.button1?.gpio === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <svg
                                x-show="usedGpioPins.has(pin) && config.buttons.button1?.gpio !== pin"
                                class="w-3 h-3 ml-1 text-gray-400"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                              >
                                <path
                                  fill-rule="evenodd"
                                  d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                  clip-rule="evenodd"
                                ></path>
                              </svg>
                            </label>
                          </template>
                        </div>

                        <!-- OFF option at bottom -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 mt-2"
                        >
                          <input
                            type="radio"
                            name="button1-gpio"
                            value="-1"
                            :checked="config.buttons.button1?.gpio === -1"
                            @change="config.buttons.button1.gpio = -1"
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                            :class="config.buttons.button1?.gpio === -1 ? 'border-blue-600 bg-blue-600' : 'border-gray-400'"
                          ></div>
                          <span
                            class="font-mono text-sm"
                            :class="config.buttons.button1?.gpio === -1 ? 'font-bold text-gray-900 dark:text-white' : 'text-gray-900 dark:text-white'"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>

                    <!-- Button 2 Card -->
                    <div
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg border-l-4 border-l-cyan-600"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          Button 2
                        </h4>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'button2-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.buttons.button2?.gpio !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="button2-gpio"
                                :value="pin"
                                :checked="config.buttons.button2?.gpio === pin"
                                :disabled="usedGpioPins.has(pin) && config.buttons.button2?.gpio !== pin"
                                @change="config.buttons.button2.gpio = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.buttons.button2?.gpio === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.buttons.button2?.gpio !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.buttons.button2?.gpio !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.buttons.button2?.gpio === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <svg
                                x-show="usedGpioPins.has(pin) && config.buttons.button2?.gpio !== pin"
                                class="w-3 h-3 ml-1 text-gray-400"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                              >
                                <path
                                  fill-rule="evenodd"
                                  d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                  clip-rule="evenodd"
                                ></path>
                              </svg>
                            </label>
                          </template>
                        </div>

                        <!-- OFF option at bottom -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 mt-2"
                        >
                          <input
                            type="radio"
                            name="button2-gpio"
                            value="-1"
                            :checked="config.buttons.button2?.gpio === -1"
                            @change="config.buttons.button2.gpio = -1"
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                            :class="config.buttons.button2?.gpio === -1 ? 'border-blue-600 bg-blue-600' : 'border-gray-400'"
                          ></div>
                          <span
                            class="font-mono text-sm"
                            :class="config.buttons.button2?.gpio === -1 ? 'font-bold text-gray-900 dark:text-white' : 'text-gray-900 dark:text-white'"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Third Row: Button 3 and Button 4 -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- Button 3 Card -->
                    <div
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg border-l-4 border-l-cyan-600"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          Button 3
                        </h4>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'button3-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.buttons.button3?.gpio !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="button3-gpio"
                                :value="pin"
                                :checked="config.buttons.button3?.gpio === pin"
                                :disabled="usedGpioPins.has(pin) && config.buttons.button3?.gpio !== pin"
                                @change="config.buttons.button3.gpio = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.buttons.button3?.gpio === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.buttons.button3?.gpio !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.buttons.button3?.gpio !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.buttons.button3?.gpio === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <span
                                x-show="usedGpioPins.has(pin) && config.buttons.button3?.gpio !== pin"
                                class="ml-1 text-xs text-gray-400 flex items-center"
                              >
                                <svg
                                  class="w-3 h-3 mr-1"
                                  fill="currentColor"
                                  viewBox="0 0 20 20"
                                >
                                  <path
                                    fill-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    clip-rule="evenodd"
                                  ></path>
                                </svg>
                              </span>
                            </label>
                          </template>
                        </div>

                        <!-- OFF option at bottom -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 mt-2"
                        >
                          <input
                            type="radio"
                            name="button3-gpio"
                            value="-1"
                            :checked="config.buttons.button3?.gpio === -1"
                            @change="config.buttons.button3.gpio = -1"
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                            :class="config.buttons.button3?.gpio === -1 ? 'border-blue-600 bg-blue-600' : 'border-gray-400'"
                          ></div>
                          <span
                            class="font-mono text-sm"
                            :class="config.buttons.button3?.gpio === -1 ? 'font-bold text-gray-900 dark:text-white' : 'text-gray-900 dark:text-white'"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>

                    <!-- Button 4 Card -->
                    <div
                      class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl p-5 shadow-lg border-l-4 border-l-cyan-600"
                    >
                      <div class="text-center mb-4">
                        <h4
                          class="font-semibold text-gray-900 dark:text-white text-lg mb-2"
                        >
                          Button 4
                        </h4>
                      </div>
                      <div class="space-y-1">
                        <!-- Available GPIO pins in grid -->
                        <div class="grid grid-cols-2 gap-1">
                          <template
                            x-for="pin in config.gpio.safePins.filter(p => p !== -1).sort((a,b) => a-b)"
                            :key="'button4-' + pin"
                          >
                            <label
                              class="flex items-center p-2 rounded-lg transition-colors duration-200"
                              :class="usedGpioPins.has(pin) && config.buttons.button4?.gpio !== pin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700'"
                            >
                              <input
                                type="radio"
                                name="button4-gpio"
                                :value="pin"
                                :checked="config.buttons.button4?.gpio === pin"
                                :disabled="usedGpioPins.has(pin) && config.buttons.button4?.gpio !== pin"
                                @change="config.buttons.button4.gpio = pin"
                                class="sr-only"
                              />
                              <div
                                class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                                :class="config.buttons.button4?.gpio === pin ? 'border-blue-600 bg-blue-600' : (usedGpioPins.has(pin) && config.buttons.button4?.gpio !== pin ? 'border-gray-300' : 'border-gray-400')"
                              ></div>
                              <span
                                class="font-mono text-sm"
                                :class="[
                                                              usedGpioPins.has(pin) && config.buttons.button4?.gpio !== pin ? 'text-gray-400' : 'text-gray-900 dark:text-white',
                                                              config.buttons.button4?.gpio === pin ? 'font-bold' : 'font-normal'
                                                          ]"
                                x-text="pin"
                              ></span>
                              <span
                                x-show="usedGpioPins.has(pin) && config.buttons.button4?.gpio !== pin"
                                class="ml-1 text-xs text-gray-400 flex items-center"
                              >
                                <svg
                                  class="w-3 h-3 mr-1"
                                  fill="currentColor"
                                  viewBox="0 0 20 20"
                                >
                                  <path
                                    fill-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    clip-rule="evenodd"
                                  ></path>
                                </svg>
                              </span>
                            </label>
                          </template>
                        </div>

                        <!-- OFF option at bottom -->
                        <label
                          class="flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 mt-2"
                        >
                          <input
                            type="radio"
                            name="button4-gpio"
                            value="-1"
                            :checked="config.buttons.button4?.gpio === -1"
                            @change="config.buttons.button4.gpio = -1"
                            class="sr-only"
                          />
                          <div
                            class="w-4 h-4 border-2 rounded-full mr-2 transition-all duration-200"
                            :class="config.buttons.button4?.gpio === -1 ? 'border-blue-600 bg-blue-600' : 'border-gray-400'"
                          ></div>
                          <span
                            class="font-mono text-sm"
                            :class="config.buttons.button4?.gpio === -1 ? 'font-bold text-gray-900 dark:text-white' : 'text-gray-900 dark:text-white'"
                            >OFF</span
                          >
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center gap-8 pt-6">
              <button
                type="submit"
                :disabled="!canSave"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-4 px-6 rounded-xl transition-all duration-200 hover:scale-[1.02] hover:shadow-xl transform active:scale-95 shadow-lg cursor-pointer"
                :class="{ 'opacity-50 cursor-not-allowed': !canSave }"
              >
                <span x-show="!saving" class="flex items-center justify-center">
                  <svg
                    class="w-5 h-5 mr-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    ></path>
                  </svg>
                  Save Device Settings
                </span>
                <span
                  x-show="saving"
                  class="flex items-center justify-center space-x-2"
                >
                  <div
                    class="animate-spin rounded-full border-2 border-white border-t-transparent w-5 h-5"
                  ></div>
                  <span>Saving...</span>
                </span>
              </button>
              <button
                type="button"
                @click="cancelConfiguration"
                class="sm:flex-initial sm:w-32 text-gray-700 dark:text-gray-300 py-3 px-4 rounded-xl font-medium transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-300 dark:border-gray-600 cursor-pointer"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </template>
    </main>
  </body>
</html>
